<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glitch: Seoul Login EP.004 - Swiss Protocol</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root {
            --color-theme: #FF3333; /* Digital Swiss Red */
            --color-cyan: #00FFFF;  /* Glitch/Hacker Color (Existing) */
            --color-magenta: #FF0055; /* Secondary Accent */
        }

        /* ▼▼▼ ここから追記：ゲーム用の固有スタイル ▼▼▼ */

        /* 1. 全体を中央寄せするラッパー */
        .game-wrapper {
            width: 100%;
            display: flex;
            justify-content: center; /* これがないと左に寄ります */
            padding: 0 0 100px 0;
        }

        /* 2. ゲーム画面のコンテナ（サイズと位置の基準） */
        .game-container {
            position: relative;     /* これがないとオーバーレイが重なりません */
            width: 90%;
            max-width: 450px;
            height: 500px;          /* これがないと縦に潰れます */
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
        }

        /* 3. ゲーム本体 (iframe) */
        iframe.game-frame {
            width: 100%;
            height: 100%;
            border: 2px solid var(--color-cyan);
            background-color: #050505;
            display: block;
            pointer-events: none; /* 初期はクリック無効 */
            transition: all 0.3s;
        }

        /* 4. オーバーレイ（WARNING等の文字表示） */
        .game-overlay {
            position: absolute; /* 親(container)に対して絶対配置 */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            backdrop-filter: blur(3px);
            cursor: pointer;
            transition: all 0.5s ease;
        }

        .overlay-content {
            text-align: center;
            font-family: var(--font-ui);
            width: 90%;
        }

        /* 状態A: WARNING (初期) */
        .game-overlay .status-msg { color: var(--color-magenta); font-size: 12px; margin-bottom: 5px; }
        .game-overlay .main-title { 
            font-size: 24px; font-weight: 900; margin-bottom: 20px; color: var(--color-magenta);
            animation: blink-text 1.5s infinite; 
        }
        .game-overlay .action-btn {
            display: inline-block;
            font-size: 14px; font-weight: bold; padding: 10px 20px;
            color: #000; background-color: var(--color-magenta);
            animation: pulse-border 2s infinite;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        }

        /* 状態B: HACKED (クリア後) */
        .game-overlay.hacked {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
            pointer-events: auto !important;
        }
        .game-overlay.hacked .status-msg { color: var(--color-cyan); }
        .game-overlay.hacked .main-title {
            color: var(--color-cyan);
            text-shadow: 0 0 20px var(--color-cyan);
            animation: none;
        }
        .game-overlay.hacked .action-btn {
            background-color: var(--color-cyan);
            box-shadow: 0 0 20px rgba(0,255,255,0.5);
            animation: none;
            cursor: default;
        }

        /* アニメーション */
        @keyframes blink-text {
            0% { opacity: 1; text-shadow: 0 0 10px var(--color-magenta); }
            50% { opacity: 0.6; text-shadow: 0 0 20px var(--color-magenta); }
            100% { opacity: 1; text-shadow: 0 0 10px var(--color-magenta); }
        }
        @keyframes pulse-border {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(255,0,85,0.4); }
            70% { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,0,85,0); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,0,85,0); }
        }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P68TDMW1FN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-P68TDMW1FN');
    </script>

    <!-- Microsoft Clarity tag -->
    <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "uujhwpbxld");
    </script>

    <!-- AIO tag -->
    <meta name="description" content="Play Glitch: Seoul Login Episode 4 'Swiss Protocol'. Trace the money flow from KOSPI to BlackRock's Aladdin and the Bank for International Settlements (BIS) in Basel. Features an interactive 'Rapid Code Breaker' mini-game.">
    
    <meta property="og:type" content="article">
    <meta property="og:title" content="EP.04 - Glitch: Seoul Login">
    <meta property="og:description" content="Target: BlackRock & BIS. Kang Ji-hoon hacks the financial system to find the 'Central Bank of Central Banks'. Interactive hacking game included.">
    <meta property="og:url" content="https://studioscotoma.github.io/webtoon/glitch/ep004.html">
    <meta property="og:image" content="https://studioscotoma.github.io/webtoon/glitch/ep004/cover.webp">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="EP.04 - Glitch: Seoul Login">
    <meta name="twitter:description" content="From Seoul to Basel. Hacking BlackRock's Aladdin and the BIS.">
    <meta name="twitter:image" content="https://studioscotoma.github.io/webtoon/glitch/ep004/cover.webp">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "ComicIssue",
      "name": "Glitch: Seoul Login Episode 4",
      "issueNumber": "4",
      "url": "https://studioscotoma.github.io/webtoon/glitch/ep004.html",
      "image": "https://studioscotoma.github.io/webtoon/glitch/ep004/cover.webp",
      "description": "Episode 4 of Glitch: Seoul Login. Kang Ji-hoon investigates the capital outflow from Korea to BlackRock and discovers a connection to the Bank for International Settlements (BIS) in Switzerland. Players must use the 'Rapid Code Breaker' mini-game to bypass security.",
      "author": {
        "@type": "Organization",
        "name": "Studio SCOTOMA"
      },
      "partOfSeries": {
        "@type": "ComicSeries",
        "name": "Glitch: Seoul Login",
        "url": "https://studioscotoma.github.io/webtoon/"
      },
      "inLanguage": "ja"
    }
    </script>
    <script src="js/viewer.js"></script>
    <script src="js/navigation.js"></script>
</head>
<body>

    <div id="cover-screen">
        <img id="cover-image" src="ep004/cover.webp" alt="Glitch: Seoul Login EP.004 Cover" onerror="this.src='https://placehold.co/690x1000/000000/FF00FF?text=EP.004+Cover'">
        <button id="start-button">CONNECT TO SEOUL</button>
    </div>
    
    <div id="viewer-container">
        <div id="comic-content"></div>
        <div id="navigation-placeholder"></div>
    </div>

    <script>
        const scenarioData = [
            {
                type: 'image',
                id: 1,
                kr: "경기도의 어느 PC방",
                ja: "京畿道（キョンギド）のPC房",
                fr: "Un cybercafé de Gyeonggi-do",
                en: "A PC Bang in Gyeonggi-do"
            },
            {
                type: 'image',
                id: 2,
                kr: "BBQ 치즈 치킨 버거",
                ja: "BBQチーズチキンバーガー",
                fr: "Burger au poulet et fromage BBQ",
                en: "BBQ Cheese Chicken Burger"
            },
            {
                type: 'image',
                id: 3,
                kr: "(우적우적)",
                ja: "（食べる）",
                fr: "(Mange)",
                en: "(Munching)"
            },
            {
                type: 'image',
                id: 4,
                kr: "국민연금공단, 코스피(KOSPI) ETF에 5천억 원 자금 투입",
                ja: "国民年金公団、韓国株価指数(KOSPI)ETFに5,000億ウォンの資金投入",
                fr: "Le Service national de retraite injecte 500 milliards de wons dans des ETF KOSPI",
                en: "National Pension Service injects 500 billion won into KOSPI ETFs"
            },
            {
                type: 'image',
                id: 5,
                kr: "이걸로 됐나.",
                ja: "これでいいか。",
                fr: "Ça devrait aller.",
                en: "This should do it."
            },
            {
                type: 'image',
                id: 6,
                kr: "타닥... 타다닥...",
                ja: "キーボードを叩く",
                fr: "Tac... Tac tac...",
                en: "Clack... Clack clack..."
            },
            // ▼▼▼ GAME INSERTION ▼▼▼
            {
                type: 'game',
                id: 'GAME_VS_DAEMON',
                src: 'game/rapidCodeBreaker/establish.html'
            },
            // ▲▲▲ GAME END ▲▲▲
            {
                type: 'image',
                id: 7,
                kr: "ESTABLISHED",
                ja: "ESTABLISHED",
                fr: "ESTABLISHED",
                en: "ESTABLISHED"
            },
            {
                type: 'image',
                id: 8,
                kr: "여의도 증권거래소에서 재벌에게로 자금이 흐른다.",
                ja: "汝矣島（ヨイド）証券取引所から財閥へ資金が流れる",
                fr: "Les fonds circulent de la Bourse de Yeouido vers les Chaebols.",
                en: "Funds flow from the Yeouido Stock Exchange to the Chaebols."
            },
            {
                type: 'image',
                id: 9,
                kr: "자금이 유출된다.",
                ja: "資金が流出する",
                fr: "Sortie de capitaux.",
                en: "Capital outflow."
            },
            {
                type: 'image',
                id: 10,
                kr: "국내 기업은 그저 프록시(Proxy)인가?",
                ja: "国内企業はプロキシか。",
                fr: "Les entreprises nationales ne sont-elles que des proxys ?",
                en: "Are domestic companies just proxies?"
            },
            {
                type: 'image',
                id: 11,
                kr: "5천억 원은 전부 해외로 빠져나간다.",
                ja: "5000億ウォンは全て海外に流出",
                fr: "La totalité des 500 milliards de wons s'écoule vers l'étranger.",
                en: "The entire 500 billion won flows overseas."
            },
            {
                type: 'image',
                id: 12,
                kr: "해저 광섬유 케이블을 타고 태평양을 통과해...",
                ja: "海底の光ファイバーケーブルを通って太平洋を通過",
                fr: "Traversant le Pacifique via des câbles à fibre optique sous-marins...",
                en: "Crossing the Pacific via undersea fiber optic cables..."
            },
            {
                type: 'image',
                id: 13,
                kr: "블랙록(BlackRock)에 도착.",
                ja: "ブラックロックに到着",
                fr: "Arrivée chez BlackRock.",
                en: "Arriving at BlackRock."
            },
            {
                type: 'image',
                id: 14,
                kr: "그딴 건 누구나 다 알아. 안을 보여줘.",
                ja: "そんな事は誰でも分かってる。中を見せろ。",
                fr: "Tout le monde sait ça. Montre-moi l'intérieur.",
                en: "Everyone knows that. Show me the inside."
            },
            {
                type: 'image',
                id: 15,
                kr: "구속되어 있는 블랙록의 알라딘(Aladdin).",
                ja: "拘束されているBlack Rock の Aladdin(AI)",
                fr: "Aladdin (IA) de BlackRock, enchaîné.",
                en: "BlackRock's Aladdin (AI), restrained."
            },
            {
                type: 'image',
                id: 16,
                kr: "알라딘을 억제하고 있는 붉은 회선.",
                ja: "Aladdin(AI) を抑える赤い回線",
                fr: "Des lignes rouges qui brident Aladdin.",
                en: "Red lines suppressing Aladdin."
            },
            {
                type: 'image',
                id: 17,
                kr: "붉은 회선의 발신 IP를 전수 조사(Brute Force).",
                ja: "赤い回線の送信元IPを総当り検索",
                fr: "Attaque par force brute sur l'IP source des lignes rouges.",
                en: "Brute-forcing the source IP of the red lines."
            },
            {
                type: 'image',
                id: 18,
                kr: "국가명: 스위스",
                ja: "国名:スイス",
                fr: "Pays : Suisse",
                en: "Country: Switzerland"
            },
            {
                type: 'image',
                id: 19,
                kr: "스위스, 바젤(Basel).",
                ja: "スイス国バーゼル市",
                fr: "Bâle, Suisse.",
                en: "Basel, Switzerland."
            },
            {
                type: 'image',
                id: 20,
                kr: "스위스 바젤, 국제결제은행(BIS) 본부 빌딩.",
                ja: "スイス国バーゼル市の国際決済銀行(BIS)本部ビル",
                fr: "Le siège de la Banque des règlements internationaux (BRI) à Bâle.",
                en: "Bank for International Settlements (BIS) headquarters in Basel."
            },
            {
                type: 'image',
                id: 21,
                kr: "바젤 규제인가.",
                ja: "バーゼル規制か。",
                fr: "Les Accords de Bâle ?",
                en: "The Basel Accords?"
            },
            {
                type: 'image',
                id: 22,
                kr: "바젤 규제 코드가 단 한 글자만 바뀌어도, 전 세계 은행이 파탄 나지.",
                ja: "バーゼル規制のコードが1文字変わると、世界中の銀行が破綻する。",
                fr: "Changez un caractère du code de Bâle, et les banques du monde entier s'effondrent.",
                en: "Change one character in the Basel code, and banks worldwide collapse."
            },
            {
                type: 'image',
                id: 23,
                kr: "BIS는 그 어떤 정부의 간섭도 받지 않고, 과세도 면제되며, 치외법권을 가진다.",
                ja: "BISは、いかなる政府の干渉も受けず、課税もされず、治外法権を持つ。",
                fr: "La BRI est immunisée contre toute ingérence gouvernementale, exonérée d'impôts et jouit de l'extraterritorialité.",
                en: "The BIS is immune to government interference, tax-exempt, and holds extraterritorial rights."
            },
            {
                type: 'image',
                id: 24,
                kr: "바젤 규제는 전 세계 은행들이 사실상 강제로 따라야 하는 룰이야.",
                ja: "バーゼル規制は世界中の銀行が事実上で強制されるルールだ。",
                fr: "Les Accords de Bâle sont des règles que les banques du monde entier sont forcées de suivre.",
                en: "The Basel Accords are rules that banks worldwide are effectively forced to follow."
            },
            {
                type: 'image',
                id: 25,
                kr: "유엔이 정한 정책조차 거부할 권리는 어디로 사라졌지?",
                ja: "国連が決めた政策を強制されない権利はどこに消えた？",
                fr: "Où est passé le droit de refuser les politiques mandatées par l'ONU ?",
                en: "Where did the right to refuse UN-mandated policies disappear to?"
            },
            {
                type: 'image',
                id: 26,
                kr: "게임 밸런스가 완전히 맛이 갔군.",
                ja: "ゲームバランスがイカれてやがる。",
                fr: "L'équilibre du jeu est complètement pété.",
                en: "The game balance is totally broken."
            },
            {
                type: 'image',
                id: 27,
                kr: "바젤 규제의 참조원은 민간 신용평가사들이야.",
                ja: "バーゼル規制の参照元は民間の格付け会社だ。",
                fr: "Les Accords de Bâle se réfèrent à des agences de notation privées.",
                en: "The Basel Accords reference private credit rating agencies."
            },
            {
                type: 'image',
                id: 28,
                kr: "S&P, 무디스, 피치... 전부 개인적인 티어(Tier) 표 놀이일 뿐이지.",
                ja: "S&P、ムーディーズ、フィッチ、どれも個人レベルのティア表(格付け)だ。",
                fr: "S&P, Moody's, Fitch... ce ne sont que des tier lists subjectives.",
                en: "S&P, Moody's, Fitch... they're all just personal tier lists."
            },
            {
                type: 'image',
                id: 29,
                kr: "민간 등급이 '마스터', 국가가 '슬레이브'인 시스템인 거야.",
                ja: "民間格付けが『Master』、国が『Slave』のシステムだ。",
                fr: "Un système où la notation privée est « Maître » et l'État est « Esclave ».",
                en: "A system where private ratings are 'Master' and nations are 'Slave'."
            },
            {
                type: 'image',
                id: 30,
                kr: "중앙은행을 위한 은행.",
                ja: "中央銀行のための銀行",
                fr: "La banque centrale des banques centrales.",
                en: "The central bank for central banks."
            },
            {
                type: 'image',
                id: 31,
                kr: "GLITCH: SEOUL LOGIN",
                ja: "GLITCH: SEOUL LOGIN",
                fr: "GLITCH: SEOUL LOGIN",
                en: "GLITCH: SEOUL LOGIN"
            }
        ];
        // 1. インスタンス生成
        const viewer = new GlitchViewer({
            filePrefix: 'ep004/scene',  // 画像パスのプレフィックス
            debugMode: false
        });

        // 2. 「game」タイプの描画ロジックを登録（ここだけEP.004固有）
        viewer.registerType('game', (scene) => {
            // ここに元のコードにあった createGameElement の中身を書く
            const wrapper = document.createElement('div');
            wrapper.className = 'game-wrapper';
            
            const container = document.createElement('div');
            container.className = 'game-container';

            // iframe作成
            const iframe = document.createElement('iframe');
            iframe.className = 'game-frame';
            iframe.src = scene.src;
            
            // オーバーレイ作成
            const overlay = document.createElement('div');
            overlay.className = 'game-overlay';
            overlay.innerHTML = `
                <div class="overlay-content">
                    <div class="status-msg">WARNING: FIREWALL DETECTED</div>
                    <div class="main-title">START HACK</div>
                    <div class="action-btn">[ INITIATE BREACH ]</div>
                </div>`;

            // クリックイベント
            overlay.addEventListener('click', function() {
                // if(this.classList.contains('hacked')) return;
                // this.style.opacity = '0';
                // setTimeout(() => { this.style.display = 'none'; }, 500);
                // iframe.style.pointerEvents = 'auto';
                if(this.classList.contains('hacked')) return;
                
                // ▼▼▼ 追加: ゲーム開始の合図を送る ▼▼▼
                iframe.contentWindow.postMessage('GAME_START', '*');
                // ▲▲▲ 追加終了 ▲▲▲

                this.style.opacity = '0';
                setTimeout(() => { this.style.display = 'none'; }, 500);
                iframe.style.pointerEvents = 'auto';
            });

            container.appendChild(iframe);
            container.appendChild(overlay);
            wrapper.appendChild(container);
            
            return wrapper;
        });

        // 3. ゲームクリア監視用イベントリスナー（EP.003固有）
        window.addEventListener('message', function(event) {
            if (event.data === 'GAME_CLEAR') {
                const overlay = document.querySelector('.game-overlay');
                const iframe = document.querySelector('.game-frame');
                if (overlay && iframe) {
                    overlay.style.display = 'flex';
                    requestAnimationFrame(() => {
                        overlay.style.opacity = '1';
                        overlay.classList.add('hacked');
                        overlay.querySelector('.overlay-content').innerHTML = `
                             <div class="status-msg">SYSTEM HACKED</div>
                             <div class="main-title">COMPLETE</div>
                             <div class="action-btn">[ ACCESS GRANTED ]</div>`;
                    });
                    iframe.style.pointerEvents = 'none';
                    iframe.style.borderColor = "#00FFFF"; // 色変数の利用を推奨
                }
            }
        });

        // 4. 開始
        viewer.init(scenarioData);
        
        // 第1引数: 現在のエピソード番号
        // 第2引数: 全エピソード数 (ここだけ管理すればOK)
        renderNavigation(4, 5);
    </script>
</body>
</html>
